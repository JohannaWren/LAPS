---
title: "Defining release locations for LAPS simulations"
author: Johanna LK Wren
date: June 11, 2021
output:
  html_notebook:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      tod_depth: 3
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/Desktop/')  # this sets the default working directory for your script. Change it to fit the folder you are working in
```

# Description
This code takes a trajectory file generated by OceanParcels and plots trajectories and makes a series of images for use in a gif. 
I did a lot of fine tuneing by hand to get the 'right' number of release locations for each site and to make the LAPS_releasePoints_halo.png file to look the way it does. This code does not produce that exact figure but it's close enough and captures the process I went through. 

# Load libraries
```{r}
library(ncdf4)
library(lubridate)
#library(ggplot2)
#library(ggquiver)
library(dplyr)
library(maptools)
library(raster)
library(rgeos)
```

# Load files
```{r}
pts <- read.csv('LAPS_release_sites_short.csv')
#test <- raster('LAPS_landMask_NA.nc')
hycom <- raster('HYCOM/HYCOM_LAPS_3501.nc')
test <- hycom
```


# Make a mask and buffer around each release site that we place the points on

```{r}
# Generate buffer around land for release points
releasePoints <- data.frame()
for (i in c(1,2,6:9,12)) {
  testSub <- crop(test, extent(pts$Lon[i]-0.5, pts$Lon[i]+0.5, pts$Lat[i]-0.5, pts$Lat[i]+0.5))
  testMask <- mask(x=is.na(testSub[[1]]), mask=testSub[[1]], inverse=T)
  plot(testMask)
  NAfield <- rasterToPolygons(testMask)

  # Remove internal polygon borders
  NApoly <- gUnaryUnion(NAfield)     #join/merge intersecting geometries
  testBuffer <- buffer(NApoly, 0.04)
  testLine <- as(testBuffer, 'SpatialLines')
  testPoint <- spsample(testLine, n=6, type='regular')

  # Plot
  plot(pts$Lon[i], pts$Lat[i], pch=20, xlim=c(pts$Lon[i]-0.5, pts$Lon[i]+0.5), ylim=c(pts$Lat[i]-0.5, pts$Lat[i]+0.5), col='red')
  plot(NApoly, add=T)
  plot(testPoint, pch=19, add=T)
  plot(testLine, add=T)
  
  releasePoints <- rbind(releasePoints, data.frame(testPoint, Site=i))
  #readline(prompt="Press [enter] to continue")
}

colnames(releasePoints) <- c('Lon', 'Lat', 'Site')
```

# Plot release locations on HYCOM background. 
The resulting plot is not the same as the one in the LAPS google folder. That was was made pretty by a lot of tweaking by hand for each location. 

```{r}
plt <- list()
for (i in 1:nrow(pts)) {
  myDat <- crop(hycom, extent(pts$Lon[i]-0.5, pts$Lon[i]+0.5, pts$Lat[i]-0.5, pts$Lat[i]+0.5))
  myDatdf <- data.frame(rasterToPoints(myDat))
  colnames(myDatdf) <- c('lon', 'lat', 'uvel')
  plt[[i]] <- ggplot() + 
    geom_tile(data=myDatdf, aes(lon, lat, fill=uvel)) + 
    scale_fill_viridis_c(guide=F) + 
    coord_map('mercator') + #mollweide
    scale_x_continuous(expand=c(0, 0)) +
    scale_y_continuous(expand=c(0, 0)) +
    geom_point(data=pts[i,2:3], aes(Lon, Lat), color='white', fill='red', shape=21, size=3) +
    geom_point(data=releasePoints[which(releasePoints$Site == i),], aes(Lon, Lat), color='white', fill='black', shape=21, size=3) +
    theme_bw() + 
    ggtitle(pts$Name[i])
}

#ggsave(filename = 'LAPS_releasePoints_halo.png', plot = grid.arrange(plt[[1]], plt[[2]], plt[[3]],plt[[4]], plt[[5]], plt[[6]],plt[[7]], plt[[8]], plt[[9]],plt[[10]], plt[[11]], plt[[12]], ncol=3), width=10, height=14, dpi=300)
```
